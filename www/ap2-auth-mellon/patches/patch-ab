$NetBSD: patch-ab,v 1.1 2009/06/06 10:27:31 manu Exp $
diff -r -U4 auth_mellon_handler.c.orig auth_mellon_handler.c
--- auth_mellon_handler.c.orig	2009-06-05 22:07:17.000000000 +0200
+++ auth_mellon_handler.c	2009-06-06 11:59:24.000000000 +0200
@@ -82,9 +82,29 @@
     am_dir_cfg_rec *cfg = am_get_dir_cfg(r);
     char *url = am_get_endpoint_url(r);
     char *cert = "";
 
-    if (cfg->sp_cert_file)
+    if (cfg->sp_cert_file) {
+	char *sp_cert_file;
+        char *cp;
+        const char *begin = "-----BEGIN CERTIFICATE-----";
+        const char *end = "-----END CERTIFICATE-----";
+
+        /* 
+         * Try to remove leading and trailing garbage, as it can
+         * wreak havoc XML parser if it contains [<>&]
+         */
+	sp_cert_file = apr_pstrdup(p, cfg->sp_cert_file);
+
+        cp = strstr(sp_cert_file, begin);
+        if (cp != NULL) 
+            sp_cert_file = cp;
+
+        cp = strstr(sp_cert_file, end);
+        if (cp != NULL)
+            *(cp + strlen(end)) = '\0';
+        
+
         cert = apr_psprintf(p,
           "<KeyDescriptor use=\"signing\">"
             "<ds:KeyInfo xmlns:ds=\"http://www.w3.org/2000/09/xmldsig#\">"
               "<ds:X509Data>"
@@ -98,10 +118,11 @@
                 "<ds:X509Certificate>%s</ds:X509Certificate>"
               "</ds:X509Data>"
             "</ds:KeyInfo>"
           "</KeyDescriptor>",
-          cfg->sp_cert_file,
-          cfg->sp_cert_file);
+          sp_cert_file,
+          sp_cert_file);
+    }
 
     return apr_psprintf(p,
       "<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>"
       "<EntityDescriptor "
