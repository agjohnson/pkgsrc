$NetBSD: patch-ac,v 1.13 2009/11/10 18:35:13 wiz Exp $

--- dyn_load.c.orig	2007-12-18 23:37:12.000000000 +0000
+++ dyn_load.c
@@ -78,6 +78,8 @@ static int (*GC_has_static_roots)(const 
 #endif
 
 #if defined(NETBSD)
+#   include <sys/param.h>
+#   include <dlfcn.h>
 #   include <machine/elf_machdep.h>
 #   define ELFSIZE ARCH_ELFSIZE
 #endif
@@ -499,6 +501,15 @@ GC_FirstDLOpenedLinkMap()
         return(0);
     }
     if( cachedResult == 0 ) {
+#if defined(NETBSD) && defined(__NetBSD_Version__) && __NetBSD_Version__ >= 599001900
+        struct link_map *lm = NULL;
+        int rv = dlinfo(RTLD_SELF, RTLD_DI_LINKMAP, &lm); 
+        if (rv != 0)
+            return (0);
+        if (lm == NULL)
+            return (0);
+        cachedResult = lm;
+#else  /* !(defined(NETBSD) && __NetBSD_Version__ >= 599001900) */
         int tag;
         for( dp = _DYNAMIC; (tag = dp->d_tag) != 0; dp++ ) {
             if( tag == DT_DEBUG ) {
@@ -508,6 +519,7 @@ GC_FirstDLOpenedLinkMap()
                 break;
             }
         }
+#endif /* !(defined(NETBSD) && __NetBSD_Version__ >= 599001900) */
     }
     return cachedResult;
 }
